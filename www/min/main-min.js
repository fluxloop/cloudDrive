function init(){"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_8_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/28.0.1500.95 Safari/537.36"==navigator.userAgent?desktopModePossible&&(desktopMode=!0,$("#desktopBackButton").show(),$("#desktopSwap").show(),alert("Desktop mode activated")):document.addEventListener("backbutton",onBackKeyDown,!1),document.addEventListener("deviceready",onDeviceReady,!1)}function debugOn(){debugOnCounter++,5==debugOnCounter&&navigator.notification.confirm("Vil du aktivere debug? (Pizza blir ikke levert, men logget)",onConfirmDebug,"Debug","Ja,Nei")}function onConfirmDebug(){peppesApiUrl="http://fluxloop.com/debug.php",peppesEGCUrl="http://fluxloop.com/debug.php",peppesDeliveryOrderUrl="http://fluxloop.com/debug.php"}function onDeviceReady(){function e(){a=document.getElementById("imageView"),n=a.getContext("2d"),a.addEventListener("touchstart",t,!1),a.addEventListener("touchmove",i,!1),a.addEventListener("touchend",t,!1)}function t(e){d=!1}function i(e){e.preventDefault();var t,i;t=e.touches[0].pageX,i=e.touches[0].pageY,d?(n.lineTo(t,i-50),n.stroke()):(n.beginPath(),n.moveTo(t,i-50),d=!0)}clearCanvas();var a,n,d=!1;e(),checkForConnectionAtLoad(),checkVersion(),$("#calculator").click(onCalculatorClick),addTouchListener("padlock",onPadLockClick),addTouchListener("reset",onResetClick),desktopMode&&($("#calculator").click(onCalculatorClick),$("#reset").click(onResetClick),$("#padlock").click(onPadLockClick))}function onBackKeyDown(){if(0==screenLevel){var e=function(e){1==e&&exit()};if(desktopMode)return void e(1);navigator.notification.confirm("Vil du avslutte?",e,"Lukk applikasjon","Ja,Nei")}else if(1==screenLevel)resetApp();else if(2==screenLevel)hideDestinationsList(),showProductList(),screenLevel=1;else if(3==screenLevel)hideDestinationsDetails(),showDestinationsList(),screenLevel=2;else if(4==screenLevel){var t=function(e){1==e&&(hidePayment(),showDestinationsDetails(),screenLevel=3)};desktopMode&&t(1),navigator.notification.confirm("Avbryt betalingen?",t,"Betaling","Ja,Nei")}else 5==screenLevel?alert("Kan ikke avbryte betalingen etter signering"):6==screenLevel?(hideAddGiftCard(),showPayment(),screenLevel=4):7==screenLevel?(hideVerifyCellPhone(),showPayment(),screenLevel=4):8==screenLevel?(hideAdvancedPayment(),showPayment(),screenLevel="credit"==Basket[lastOrderId].paymentType?5:4):9==screenLevel?(hideSignature(),showDestinationsDetails(),screenLevel=3):10==screenLevel?(screenLevel=8,hideDiscountSelection(),showAdvancedPayment()):11==screenLevel?(hideComplaintSelection(),showAdvancedPayment(),screenLevel=8):12==screenLevel?(hideComplaintOrderLineSelection(),showComplaintSelection(),screenLevel=11):13==screenLevel&&(hideVerifyCellPhone(),showAdvancedPayment(),screenLevel=8)}function hideDiscountSelection(){$("#discountSelectionHeader").hide(),$("#discountSelection").hide()}function hideSignature(){$("#sign").hide(),$("#signButton"+lastOrderId).hide()}function hideAddGiftCard(){$("#addGiftCard"+lastOrderId).hide(),$("#addGiftCard").hide()}function hideVerifyCellPhone(){$("#verifyCellPhone").hide(),$("#verifyCellPhone"+lastOrderId).hide()}function showVerifyCellPhone(){$("#reset").hide(),$("#calculator").hide(),$("#verifyCellPhone").show(),$("#verifyCellPhone"+lastOrderId).show()}function showDestinationInfo(){$("#tab2").removeClass("selected"),$("#destinationItemList").hide(),$("#tab1").addClass("selected"),$("#destinationInfo").show()}function showDestinationItemList(){$("#tab1").removeClass("selected"),$("#destinationInfo").hide(),$("#tab2").addClass("selected"),$("#destinationItemList").show()}function showDiscountSelection(e){screenLevel=10,lastPaymentCode=e,$("#calculator").hide(),$("#reset").hide(),$("#discountSelectionHeader").show(),$("#discountSelection").show()}function showComplaintSelection(e){screenLevel=11,lastPaymentCode=e,$("#calculator").hide(),$("#reset").hide(),$("#complaintSelectionHeader").show(),$("#complaintSelection").show()}function hideComplaintSelection(e){e||(e=lastOrderId),$("#complaintSelectionHeader").hide(),$("#complaintSelection").hide()}function showComplaintOrderLineSelection(){$("#complaintSelectionHeader").show(),$("#complaintOrderLineSelection").show(),$("#complaintOrderLineList"+lastOrderId).show()}function hideComplaintOrderLineSelection(){$("#complaintSelectionHeader").hide(),$("#complaintOrderLineSelection").hide(),$("#complaintOrderLineList"+lastOrderId).hide()}function hideDiscountSelection(e){$("#discountSelectionHeader").hide(),$("#discountSelection").hide()}function hideAdvancedPayment(e){e||(e=lastOrderId),$("#reset").hide(),$("#calculator").hide(),$("#advancedPaymentHeader").hide(),$("#advancedPayment").hide(),$("#advancedPayment"+e).hide()}function showAdvancedPayment(e){e||(e=lastOrderId),$("#advancedPaymentHeader").show(),$("#advancedPayment").show(),$("#advancedPayment"+e).show(),$("#calculator").show(),$("#reset").show()}function hideProductList(){$("#products").hide(),$("#productHeader").hide(),$("#padlock").hide()}function showProductList(){$("#products").show(),$("#productHeader").show(),$("#padlock").show()}function hideDestinationsDetails(){$("#destinationsDetailsHeader").hide(),$("#destinations").hide()}function showDestinationsDetails(){$("#destinationsDetailsHeader").show(),$("#destinations").show()}function hideDestinationsList(){$("#destinationsListHeader").hide(),$("#destinationsList").hide()}function showDestinationsList(){$("#destinationsListHeader").show(),$("#destinationsList").show()}function showPayment(){$("#calculator").show(),$("#payment").show(),$("#paymentHeader").show(),$("#paymentDetails"+lastOrderId).show(),$("#paymentSelection"+lastOrderId).show()}function hidePayment(){$("#paymentDetails"+lastOrderId).hide(),$("#payment").hide(),$("#paymentHeader").hide(),$("#paymentSelection"+lastOrderId).hide(),$("#calculator").hide()}function delayedExit(){window.setTimeout(exit,500)}function exit(){navigator.app.exitApp()}function checkVersion(){$.ajax({type:"GET",url:peppesVersionUrl,dataType:"xml",success:function(e){var t=$(e).children("version").text();t==currentversion||(alert("Ny versjon finnes: "+t+" "),$("#newVersion").show())},error:function(){alert("Se etter ny versjon feilet.")}})}function Log(e,t){LogAppActivity(localStorage.userID,lastOrderId,e,t)}function LogAppActivity(e,t,i,a){$.post(fxlLogUrl,{uid:e,oid:t,act:i,logdata:a}).done(function(e){})}function checkForConnectionAtLoad(){var e=void 0!==navigator.network?navigator.network.connection.type:"desktop";return e&&"none"!=e?1:(alert("Mangler kontakt med nettverket, laster siste tur lagret i mobilen."),localstorageLoad(),$("#offline").show(),$(".button.offline").hide(),0)}function checkForConnection(){var e=void 0!==navigator.network?navigator.network.connection.type:"desktop";return e&&"none"!=e?!0:($("#offline").is(":hidden")&&alert("Ojda. Mobilen er uten dekning."),$("#offline").show(),$(".button.offline").hide(),!1)}function doLogin(){$("#loader").show(),userpin=document.getElementById("pincode").value,$("#loginDiv").hide(),$("#welcome").hide(),$("#loader").show(),loadXML(userpin),Log(activities.Login)}function onTouchStart(e){if(!isTouching){var t=e.currentTarget;e.currentTarget.moved=!1,isTouching=!0}}function onTouchMove(e){e.currentTarget.moved=!0}function onGiftCardTouchEnd(e){var t=e.currentTarget.title,i=t.split(";"),a=i[0],n=i[1];giftCardClick(a,n)}function deliveryLateTouchEnd(e){var t=e.currentTarget.title;t&&deliveryLateClick(t)}function onListTouchEnd(e){if(!screenLocked||1!=screenLevel){var t=e.currentTarget;$(t).hasClass("selected")||(t.className="selected",$("#products-total").html($("#products-total").html()-1),0==$("#products-total").html()&&($("#productsDone").click(function(){screenLocked||($("#products").hide(),$("#productHeader").hide(),$("#destinationsList").show(),$("#destinationsListHeader").show(),$("#padlock").hide(),Log(activities.AllItemsPicked),screenLevel=2)}),$("#productsDone").removeClass("disabled"),$("#productsDone").addClass("enabled"))),"0"==$("#products-total").html()&&($("#products-next").show(),$("#products-status").hide())}}function onDestListTouchEnd(e){if(!ignoreClick){var t=$(e.currentTarget).attr("title");lastOrderId=t,clickDelay(300),viewCustomer(t),window.setTimeout(setGoogleMapLinks,250)}}function setGoogleMapLinks(e){e||(e=lastOrderId),$("#"+e+"-mapaddr").click(function(){return showMap(e),!1})}function showMap(e){var t=window.open(Basket[e].googlemaps,"_blank","location=yes");t.addEventListener("loadstart",function(e){})}function onOfflineClick(){offlineMode=!offlineMode,triggerOfflineSwap()}function triggerOfflineSwap(){return offlineMode?(alert("Mangler kontakt med nettverket, laster siste tur lagret i mobilen."),localstorageLoad(),$("#offline").show(),$(".button.offline").hide(),0):1}function onTab1TouchEnd(e){showDestinationInfo()}function onTab2TouchEnd(e){showDestinationItemList()}function loadXML(e){"12345"==e?(xmlURL=phoneLocalDriverOrdersUrl,desktopMode&&(xmlURL=localDriverOrdersUrl)):xmlURL=peppesDriverOrdersUrl+"?employeeId="+e+"&rnd="+GetUnixTime(),$.ajax({type:"GET",url:xmlURL,dataType:"xml",success:function(t){var i=t.xml?t.xml:(new XMLSerializer).serializeToString(t);localStorage.xml=i,localStorage.userID=e,parseXML(t)},error:function(){alert("Kunne ikke laste rute. Trolig server nedetid."+xmlURL),resetApp()}})}function parseXML(e){$(e).find("error").each(function(){var e=$(this).text();alert(e)});var t=$(e).find("employee").find("orders").text();if(0==t)return alert("Fant ingen ordrer."),resetApp(),void(document.getElementById("pincode").value=userpin);screenLevel=1,$("#padlock").show(),$("#productHeader").show();var i=0;$(e).find("group").each(function(){var e=$(this).attr("name");$("#productList").append("<div class='listheader'>"+e+"</div>");var t=100;$(this).find("item").each(function(){var a=i;i++;var n=$(this).attr("serialno"),d;n?d="#"+Number(n):(n=t,t++,d=Number($(this).attr("qty"))+" stk");var s="",o=$(this).attr("placement");o&&(s='<span class="placement">'+o+"</span>"),"Pizza"==e&&""==o&&alert("OBS! "+$(this).text()+" "+n+" er enda ikke satt i hylle."),$("#productList").append("<div class='listitem' style='line-height: inherit; height: inherit; position: relative;'><a id='"+e+"-"+n+"-"+a+"'><strong>"+$(this).text()+"</strong><em>"+d+"</em>"+s+"</a></div>")})});var a=document.querySelectorAll("#productList a");$("#products-total").html(a.length);for(var n=0;n<a.length;++n)addTouchListener(a[n].id,onListTouchEnd);desktopMode&&$("#products .listitem").click(function(){$("#products-total").html($("#products-total").html()-1),0==$("#products-total").html()&&($("#productsDone").click(function(){$("#products").hide(),$("#productHeader").hide(),$("#padlock").hide(),$("#destinationsList").show(),$("#destinationsListHeader").show(),screenLevel=2}),$("#productsDone").removeClass("disabled"),$("#productsDone").addClass("enabled"))});var d=0;$(e).find("discountCode").each(function(){var e=$(this).attr("code"),t=$(this).attr("description");DiscountCodes[d]=[],DiscountCodes[d].code=e,DiscountCodes[d].description=t,d++}),createDiscountCodeMarkup();var s=0;$(e).find("complaintCode").each(function(){var e=$(this).attr("code"),t=$(this).attr("description");ComplaintCodes[s]=[],ComplaintCodes[s].code=e,ComplaintCodes[s].description=t,s++}),createComplaintCodeMarkup(),$(e).find("order").each(function(){var e=$(this).attr("id"),t=$(this).attr("timestamp"),i=Number($(this).attr("orderTotal")),a=$(this).attr("payment"),n=$(this).attr("preorder"),d=$(this).attr("serialno"),s=$(this).attr("deliveryWithin"),o=$(window).width(),l=$(this).attr("orderphone"),r=$(this).attr("orderDiscount");r=r?Number(r):0;var c=$(this).find("streetname").text()+" "+$(this).find("streetnumber").text()+$(this).find("streetletter").text(),p=$(this).find("city").text();"true"==n?($(".preorder").show(),$("#destinationList .preorder").append("<div class='destinationListItem listitem' title='"+e+"' id='listItem"+e+"'></div>"),$("#destinationList .preorder #listItem"+e).append("<a><strong>"+c+"</strong><em class=''>"+deliverWithin(s)+"</em></a>")):($("#destinationList .normal").append("<div class='destinationListItem listitem' title='"+e+"' id='listItem"+e+"'></div>"),$("#destinationList .normal #listItem"+e).append("<a><strong>"+c+"</strong><em class='timestamp' title='"+s+"'></em></a>")),addTouchListener("listItem"+e,onDestListTouchEnd),desktopMode&&("true"==n?$("#destinationList .preorder #listItem"+e).click(function(t){viewCustomer(e)}):$("#destinationList .normal #listItem"+e).click(function(t){viewCustomer(e)})),Basket[e]=[],Basket[e].baseOrderTotal=i,Basket[e].baseOrderTotalRebate=i/2,Basket[e].lateDelivery=0,Basket[e].orderDiscount=r,Basket[e].originalOrderTotal=i+r,Basket[e].paymentType=a,$("#destinationsDetails #destinationInfo").append("<div class='destinationsDetailsItem' style='display:none;' id='detailsItem"+e+"'></div>");var u=$(this).find("firstname").text()+" "+$(this).find("lastname").text(),v=$(this).find("phone").text(),m=$(this).find("info").text(),h=$(this).find("email").text(),f="";$(this).find("email").each(function(){h=$(this).text(),f='<option value="'+h+'">'+h+"</option>"+f}),f="<select style='width: 100%;' onChange='emailList(this,"+e+");'>"+f+"<option value=''>Ingen kvittering</option><select>",Basket[e].emailAddress=h,$("#destinationsDetails #destinationInfo #detailsItem"+e).append("<h2>"+u+"<em class='timestamp' title='"+t+"'></em></h2>").append("<ul class='icon'></ul>"),$("#destinationsDetails #destinationInfo #detailsItem"+e+" ul").append("<li><a href='#' id='"+e+"-mapaddr' href='' class='mapsbutton'><img src='http://maps.googleapis.com/maps/api/staticmap?zoom=15&size="+o+"x163&markers=size:large%7Ccolor:red%7C"+encodeURIComponent(c)+","+p+",Norway&sensor=false'/></a></li>").append("<li class='home'><a href='#' id='"+e+"-mapaddr' href='' class='mapsbutton'>"+c+"</a></li>").append("<li class='call'><a href='tel:"+v+"' >"+v+" - kundetelefon</a></li>"),l==v||$("#destinationsDetails #destinationInfo #detailsItem"+e+" ul").append("<li class='call'><a href='tel:"+l+"' >"+l+" - ordretelefon</a></li>");var y="http://maps.google.com/maps?f=q&source=s_q&hl=en&geocode=&q="+encodeURIComponent(c)+","+encodeURIComponent(p)+"&aq=1&t=m&z=11&iwloc=A";Basket[e].googlemaps=y,desktopMode&&setGoogleMapLinks(e),$("#destinationsDetails #destinationInfo #detailsItem"+e).append("<div class='info'><p>"+m+"</p></div>").append("<div class='button' onclick='arriveAtCustomer();'><div>Fremme hos kunde</div></div>"),$("#destinationsDetails #destinationItemList").append("<div class='destinationsDetailsList' style='display:none;' id='detailsList"+e+"'></div>"),$("#detailsList"+e).append("<h2>"+u+"<em class='timestamp' title='"+t+"'></em></h2>").append("<ul><li>L&oslash;penummer #"+d+"</li></ul>"),$("#complaintOrderLineSelection").append("<div class='complaintOrderLineList' style='display:none;' id='complaintOrderLineList"+e+"'></div>");var g=$("#complaintOrderLineList"+e);g.append("<div id='complaintOrderLineList"+e+"Title' class='listheader'></div>"),$(this).find("orderline").each(function(){var t,i=Number($(this).attr("price"));if(i>0){var a=Number($(this).attr("qty"));t="<li>"+a+" stk "+$(this).text()+"<strong>&agrave; "+i+" kr</strong></li>";var n=$(this).attr("number");g.append("<div id="+e+"-"+n+" class='listitem'><div class='tap' title='"+n+"'>"+$(this).text()+"</div></div>"),addTouchListener(e+"-"+n,onComplaintOrderLineSelected),desktopMode&&$("#"+e+"-"+n).click(function(e){onComplaintOrderLineSelected(e)})}else t="<li><span style='color: red;'>"+$(this).text()+"<strong></span></strong></li>";$("#destinationsDetails #destinationItemList #detailsList"+e+" ul").append(t)}),g.append("<div id='"+e+"-ComplaintOK' class='button'><div>Ok</div></div>"),addTouchListener(e+"-ComplaintOK",completeComplaintOrderLineSelection),desktopMode&&$("#"+e+"-ComplaintOK").click(function(e){completeComplaintOrderLineSelection()}),l&&(Basket[e].cellPhoneNumber=l),PaymentMethods[e]=[];var k=0;$(this).find("paymentMethod").each(function(){PaymentMethods[e][k]=[];var t=$(this).attr("code"),i=$(this).attr("gratuityAllowed"),a=$(this).attr("description"),n=$(this).attr("complaintCodeRequired"),d=$(this).attr("discountCodeRequired");PaymentMethods[e][k].code=t,PaymentMethods[e][k].gratuityAllowed=i,PaymentMethods[e][k].description=a,PaymentMethods[e][k].complaintCodeRequired=n,PaymentMethods[e][k].discountCodeRequired=d,GlobalPaymentMethods[t]||(GlobalPaymentMethods[t]=[],GlobalPaymentMethods[t].gratuityAllowed=i,GlobalPaymentMethods[t].description=a,GlobalPaymentMethods[t].complaintCodeRequired=n,GlobalPaymentMethods[t].discountCodeRequired=d),Basket[e][t]=1,Basket[e][t+"gratuityAllowed"]=i,t==paymentMethodGiftCard&&(Basket[e][t+"gratuityAllowed"]="true",PaymentMethods[e].gratuityAllowed="true"),k++});var C="<div class='sumList' id='sumPaymentList"+e+"'><ul></ul></div>",L="<div class='sumDetailsList' id='sumDetailsList"+e+"'><ul></ul></div>",b="<div class='egcList' id='egcPaymentList"+e+"'><ul></ul></div>",D="<div class='egcDetailsList' id='egcDetailsList"+e+"'><ul></ul></div>",P="<div class='grandTotalsList' id='grandTotalsPaymentList"+e+"'><ul></ul></div>",w="<div class='grandTotalsDetailsList' id='grandTotalsDetailsList"+e+"'><ul></ul></div>";$("#detailsList"+e).append(L).append(D).append(w),$("#payment #totals").append("<div class='paymentDetailsList' style='display:none;' id='paymentDetails"+e+"'></div>"),$("#payment #totals #paymentDetails"+e).append(C).append(b).append(P),$("#payment #paymentButtons").append("<div style='display:none;' class='paymentSelection' id='paymentSelection"+e+"'></div>");var I="",G="display: none";Basket[e].orderDiscount>0&&(I="<li style='color: green'>Avslag <strong>-"+Basket[e].orderDiscount+" kr</strong></li>",G="");var T="<li id='subTotalPayment"+e+"' style='"+G+"'>Subtotal <strong>"+Basket[e].originalOrderTotal+" kr</strong></li>",O="<li id='subTotalDetails"+e+"' style='"+G+"'>Subtotal <strong>"+Basket[e].originalOrderTotal+" kr</strong></li>",B="<li id='grandTotalsDetails"+e+"'>&Aring; betale <strong> "+Basket[e].baseOrderTotal+" kr</strong></li>",M="<li id='grandTotalsPayment"+e+"'>&Aring; betale <strong> "+Basket[e].baseOrderTotal+" kr</strong></li>",S="<li style='display: none' id='discountPayment"+e+"' class='rebate'>Rabatt 50%<strong>-"+Basket[e].baseOrderTotalRebate+" kr</strong></li>",A="<li style='display: none' id='discountDetails"+e+"' class='rebate'>Rabatt 50%<strong>-"+Basket[e].baseOrderTotalRebate+" kr</strong></li>";if($("#sumDetailsList"+e+" ul").append(O).append(I),$("#grandTotalsDetailsList"+e+" ul").append(A).append(B),$("#sumPaymentList"+e+" ul").append(T).append(I),$("#grandTotalsPaymentList"+e+" ul").append(S).append(M),"credit"==a){$("#detailsList"+e).append("<div class='button sign offline' id='showSignButton"+e+"' onclick='sign("+e+");'><div>Signatur</div></div>"),$("#signButtons").append('<div class="button buttons2" id="signButton'+e+'" style="display:none" onClick="signSave('+e+')"><div>Lagre</div></div>');var x="<div class='emailReceipt'><div>E-postkvittering:</div>"+f+"<input type='email' id='emailReceipt"+e+"' value='"+h+"' onchange='emailChanged("+e+", this.value)' onkeyup='emailChanged("+e+", this.value)' /></div>",R="<div class='deliveryLate'><div class='tap' title='"+e+"' id='deliveryLateItem"+e+"'>Forsinket levering (50% rabatt)</div></div>";desktopMode&&(R="<div class='deliveryLate'><div class='tap' title='"+e+"' id='deliveryLateItem"+e+"' onclick='deliveryLateClick("+e+")'>Forsinket levering (50% rabatt)</div></div>"),$("#payment #paymentButtons #paymentSelection"+e).append(R).append("<div class='separator'>&nbsp;</div>").append(x).append("<div class='separator'>&nbsp;</div>").append("<div class='button delivery offline' id='deliveryButton"+e+"' onclick='completePayment("+e+", -1);' style='display:none' ><div>Levert til kunde</div></div>"),addTouchListener("deliveryLateItem"+e,deliveryLateTouchEnd),createAdvancedPaymentMarkup(e)}else{if(Giftcards[e]=[],$(this).find("giftcard").size()>0){$("#sumPaymentList"+e+" ul").append(T),$("#grandTotalsPaymentList"+e+" ul").append(S),$("#subTotalPayment"+e).show(),$("#subTotalDetails"+e).show();var N=0;$(this).find("giftcard").each(function(){var t=$(this).attr("id"),i=Number($(this).attr("amount"));$("#egcDetailsList"+e+" ul").append("<li id='detailsGiftCardItem"+t+"' class='giftCard enabled' >Gavekort - "+t+"<strong> -"+i+" kr</strong></li>");var a="<li id='paymentGiftCardItem"+t+"' class='giftCard enabled' title='"+t+";"+e+"'><div class='tap'>Gavekort - "+t+"<strong> -"+i+" kr</strong></div></li>";desktopMode&&(a="<li id='paymentGiftCardItem"+t+"' class='giftCard enabled' title='"+t+";"+e+"' onclick='giftCardClick("+t+","+e+")'><div class='tap'>Gavekort - "+t+"<strong> -"+i+" kr</strong></div></li>"),$("#egcPaymentList"+e+" ul").append(a),addTouchListener("paymentGiftCardItem"+t,onGiftCardTouchEnd),Giftcards[e][N]=[],Giftcards[e][N].id=t,Giftcards[e][N].value=i,Giftcards[e][N].status=1,N++})}else $("#payment #totals #paymentDetails"+e+" ul").append(S);$("#detailsList"+e).append("<div class='button delivery offline' id='payButton"+e+"' onclick='beginPayment("+e+");'><div>Betal</div></div>");var x="<div class='emailReceipt'><div>E-postkvittering:</div>"+f+"<input type='email' id='emailReceipt"+e+"' value='"+h+"' onchange='emailChanged("+e+", this.value)' onkeyup='emailChanged("+e+", this.value)' /></div>",R="<div class='deliveryLate'><div class='tap' title='"+e+"' id='deliveryLateItem"+e+"'>Forsinket levering (50% rabatt)</div></div>";desktopMode&&(R="<div class='deliveryLate'><div class='tap' title='"+e+"' id='deliveryLateItem"+e+"' onclick='deliveryLateClick("+e+")'>Forsinket levering (50% rabatt)</div></div>");var E="<div class='button buttons2 delivery offline cash disabled' id='cashButton"+e+"'><div>Kontant</div></div>";Basket[e][paymentMethodCash]&&(E="<div class='button buttons2 delivery offline cash' id='cashButton"+e+"' onclick='completePayment("+e+", 0);'><div>Kontant</div></div>");var U="<div class='button buttons2 delivery offline card disabled' id='cardButton"+e+"'<div>Kort</div></div>";Basket[e][paymentMethodCard]&&(U="<div class='button buttons2 delivery offline card' id='cardButton"+e+"' onclick='completePayment("+e+",1);'><div>Kort</div></div>");var H="<div class='button buttons2 delivery offline cash' id='giftCardButton"+e+"' onclick='addGiftCardClick("+e+");' ><div>Gavekort</div></div>",z="<div class='button buttons2 delivery offline card' id='completeButton"+e+"' style='display: none' onclick='verifyCellPhoneNumber("+e+")'><div>Neste</div></div>";$("#payment #paymentButtons #paymentSelection"+e).append(R).append("<div class='separator'>&nbsp;</div>").append(x).append("<div class='separator'>&nbsp;</div>").append(E).append(H).append(U).append(z),addTouchListener("deliveryLateItem"+e,deliveryLateTouchEnd),$("#verifyCellPhone").append("<div style='display: none' id='verifyCellPhone"+e+"'></div>"),$("#verifyCellPhone"+e).append("<label for='cellphone"+e+"'>Telefonnummer for gavekort:</label>").append("<input class='paymentValue' type='number' name='cellPhoneNumber"+e+"' id='cellPhoneNumber"+e+"' value='"+Basket[e].cellPhoneNumber+"'>").append("<div class='button buttons2 partialPaymentCancel' onclick='cancelCellPhone("+e+")'><div>Avbryt</div></div>").append("<div class='button buttons2 offline delivery partialPayment' onclick='completeCellPhone("+e+")'><div>Fullf&oslash;r</div></div>"),$("#addGiftCard").append("<div style='display: none' id='addGiftCard"+e+"'></div>"),$("#addGiftCard"+e).append("<label for='addGiftCardNumber"+e+"'>Gavekortnummer:</label>").append("<input class='paymentValue' type='number' name='addGiftCardNumber"+e+"' id='addGiftCardNumber"+e+"'>").append("<div class='button buttons2 partialPaymentCancel' onclick='cancelAddGiftCard("+e+")'><div>Avbryt</div></div>").append("<div class='button buttons2 offline delivery partialPayment' onclick='completeAddGiftCard("+e+")'><div>Legg til</div></div>"),createAdvancedPaymentMarkup(e)}calculateOrder(e)}),addTouchListener("tab1",onTab1TouchEnd),addTouchListener("tab2",onTab2TouchEnd),initTimer(),checkForConnectionTimer(),$("#loader").hide(),$("#products").show(),$("#productsDone").show()}function createDiscountCodeMarkup(){for(var e=0;e<DiscountCodes.length;e++)$("#discountSelection").append("<div class='listitem' id='"+e+"-"+DiscountCodes[e].code+"'><strong>"+DiscountCodes[e].description+"</strong></div>"),addTouchListener(e+"-"+DiscountCodes[e].code,onDiscountCodeSelected),desktopMode&&$("#"+e+"-"+DiscountCodes[e].code).click(function(e){onDiscountCodeSelected(e)})}function onDiscountCodeSelected(e){var t=e.currentTarget.id,i=t.split("-"),a=i[0],n="Rabattkode: <span name='"+DiscountCodes[a].code+"'>"+DiscountCodes[a].description+"</span>",d=$("#"+lastPaymentCode+"-"+lastOrderId+"-discount");d.html(n),d.hasClass("selected")||d.addClass("selected"),Basket[lastOrderId].discounts||(Basket[lastOrderId].discounts=[]),Basket[lastOrderId].discounts.status=1,Basket[lastOrderId].discounts.idx=a,hideDiscountSelection(),showAdvancedPayment(),screenLevel=8,clickDelay(300)}function onComplaintOrderLineSelected(e){var t=e.currentTarget.id,i=t.split("-"),a=i[0],n=i[1],d=$("#"+a+"-"+n+" div");d.hasClass("selected")?d.removeClass("selected"):d.addClass("selected"),clickDelay(300)}function completeComplaintOrderLineSelection(e){var t=lastOrderId,i="",a="";return $("#complaintOrderLineList"+t+" .selected").each(function(){var e=$(this).attr("title");a+=i+"complaintOrderLine="+e,i="&"}),""===a?void alert("Velg minst en ordrelinje"):(Basket[t].complaintOrderLineList=a,hideComplaintOrderLineSelection(),showAdvancedPayment(),void(screenLevel=8))}function createComplaintCodeMarkup(){for(var e=0;e<ComplaintCodes.length;e++)$("#complaintSelection").append("<div class='listitem' id='"+e+"-"+ComplaintCodes[e].code+"'><strong>"+ComplaintCodes[e].description+"</strong></div>"),addTouchListener(e+"-"+ComplaintCodes[e].code,onComplaintCodeSelected),desktopMode&&$("#"+e+"-"+ComplaintCodes[e].code).click(function(e){onComplaintCodeSelected(e)})}function onComplaintCodeSelected(e){var t=e.currentTarget.id,i=t.split("-"),a=i[0],n="Reklamasjonskode: <span name='"+ComplaintCodes[a].code+"'>"+ComplaintCodes[a].description+"</span>",d=$("#"+lastPaymentCode+"-"+lastOrderId+"-complaint");d.html(n),d.hasClass("selected")||d.addClass("selected"),Basket[lastOrderId].complaints||(Basket[lastOrderId].complaints=[]),Basket[lastOrderId].complaints.status=1,Basket[lastOrderId].complaints.idx=a,$("#complaintOrderLineList"+lastOrderId+"Title").html(ComplaintCodes[a].description+" gjelder for:"),hideComplaintSelection(),clickDelay(300),showComplaintOrderLineSelection(),screenLevel=12}function createAdvancedPaymentMarkup(e){$("#advancedPayment").append("<div style='display: none' class='advancedPayment' id='advancedPayment"+e+"'><ul></ul></div>"),$("#advancedPayment"+e+" ul").append("<li>Bel&oslash;p <em>"+Basket[e].originalOrderTotal+"</em></li>");for(var t=0;t<PaymentMethods[e].length;t++){var i=PaymentMethods[e][t];if(i.code!=paymentMethodGiftCard&&i.code!=paymentMethodLateDelivery){if($("#advancedPayment"+e+" ul").append("<li id='"+i.code+"-"+e+"-li'>"+i.description+" <input id='"+i.code+"-"+e+"' name='"+i.code+"' class='payable' type='number' value=''/></li>"),"true"==i.discountCodeRequired){$("#"+i.code+"-"+e+"-li input").removeClass("payable").addClass("subtractable");var a=$("#"+i.code+"-"+e+"-li");a.after("<li><div id='"+i.code+"-"+e+"-discount' class='tap required disabled'>Rabattkode: <span>ingen valgt</span></div></li>"),a.focusout(function(e){onDiscountValueChanged(e)})}if("true"==i.complaintCodeRequired){$("#"+i.code+"-"+e+"-li input").removeClass("payable").addClass("subtractable");var a=$("#"+i.code+"-"+e+"-li");a.after("<li><div id='"+i.code+"-"+e+"-complaint' class='tap required disabled'>Reklamasjonskode: <span>ingen valgt</span></div></li>"),a.focusout(function(e){onComplaintValueChanged(e)})}}}if(Giftcards[e]){$("#advancedPayment"+e+" ul").append("<li class='egcStart' id='egcStart"+e+"'>&nbsp;</li>");for(var n=0;n<Giftcards[e].length;n++){var d=Giftcards[e][n].status,s=Giftcards[e][n].id,o=Giftcards[e][n].value;$("#advancedPayment"+e+" ul").append(d?"<li><div class='egc enabled' id='advancedPaymentGiftCardItem"+s+"'>EGK-"+s+"<input name='"+paymentMethodGiftCard+"' class='egc' type='number' disabled='disabled' value='"+o+"'/></div></li>":"<li><div class='egc' id='advancedPaymentGiftCardItem"+s+"'>EGK-"+s+"<input name='"+paymentMethodGiftCard+"' class='egc' type='number' disabled='disabled' value='"+o+"'/></div></li>")}}orderDiscountAdvancedPaymentText="",Basket[e].orderDiscount>0&&(orderDiscountAdvancedPaymentText="<li style='color: green'>Avslag <em>-"+Basket[e].orderDiscount+" kr</em></li>"),$("#advancedPayment"+e+" ul").append(orderDiscountAdvancedPaymentText).append("<li><div class='lateDelivery tap' id='lateDeliveryCheckbox"+e+"'>Forsinket levering (50% rabatt)<input type='number' class='lateDelivery' disabled='disabled' value='"+Basket[e].baseOrderTotalRebate+"'/></div></li>").append("<li id='advancedPaymentRemaining"+e+"' class='title'>Gjenst&aring;ende &aring; betale</li>").append("<li id='advancedPaymentTip"+e+"' class='title'>Tips</li>"),$("#advancedPayment"+e).append("<div id='advancedPaymentButtons"+e+"'></div>"),$("#advancedPaymentButtons"+e).append("<div id='cancelAdvancedPayment"+e+"' class='button buttons2 partialPaymentCancel' onclick='cancelAdvancedPayment("+e+")'><div>Avbryt</div></div>").append("<div id='completeAdvancedPayment"+e+"' class='button buttons2 offline delivery partialPayment'  onclick='completeAdvancedPayment("+e+")'><div style='color: green;'>Fullf&oslash;r</div></div>").append("<div id='newGiftCard"+e+"' style='display: none' class='button buttons2 offline delivery partialPayment'  onclick='verifyCellPhoneNumberAdvancedPayment("+e+")'><div style='color: green;'>Neste</div></div>"),addTouchListener("lateDeliveryCheckbox"+e,onLateDeliveryCheckboxClicked),desktopMode&&$("#lateDeliveryCheckbox"+e).click(function(e){onLateDeliveryCheckboxClicked(e)}),$("#advancedPayment"+e+" ul").focusout(function(){calculateAdvancedPayment()})}function onResetClick(e){$("#advancedPayment"+lastOrderId+" ul li input").each(function(){$(this).hasClass("lateDelivery")||$(this).hasClass("egc")||($(this).val("0"),$(this).trigger("focusout"))}),calculateAdvancedPayment()}function onDiscountValueChanged(e){var t=e.target.id.split("-"),i=t[0],a=t[1],n=$("#"+i+"-"+lastOrderId+"-li input"),d=$("#"+i+"-"+lastOrderId+"-discount");Number(n.val())>0?d.hasClass("disabled")&&(d.removeClass("disabled"),addTouchListener(d.attr("id"),onDiscountClick),desktopMode&&d.click(function(e){onDiscountClick(e)})):(n.val("0"),d.hasClass("disabled")||(d.addClass("disabled"),desktopMode&&(d.click=null)))}function onDiscountClick(e){var t=e.currentTarget;$listItem=$(t),t.id||($listItem=$listItem.parent());var i=$listItem.attr("id").split("-"),a=i[0],n=i[1];hideAdvancedPayment(n),showDiscountSelection(a)}function onComplaintValueChanged(e){var t=e.target.id.split("-"),i=t[0],a=t[1],n=$("#"+i+"-"+lastOrderId+"-li input"),d=$("#"+i+"-"+lastOrderId+"-complaint");Number(n.val())>0?d.hasClass("disabled")&&(d.removeClass("disabled"),addTouchListener(d.attr("id"),onComplaintClick),desktopMode&&d.click(function(e){onComplaintClick(e)})):(n.val("0"),d.hasClass("disabled")||(d.addClass("disabled"),desktopMode&&(d.click=null)))}function onComplaintClick(e){var t=e.currentTarget;$listItem=$(t),t.id||($listItem=$listItem.parent());var i=$listItem.attr("id").split("-"),a=i[0],n=i[1];hideAdvancedPayment(n),showComplaintSelection(a)}function clickDelay(e){ignoreClick||((!e||0>e)&&(e=300),ignoreClick=!0,window.setTimeout(swapClick,e))}function swapClick(){ignoreClick=!ignoreClick}function cancelAdvancedPayment(){ignoreClick||onBackKeyDown()}function calculateGiftCardTotalValue(e){var t=0;if(Giftcards[e])for(var i=0;i<Giftcards[e].length;i++)1==Giftcards[e][i].status&&(t+=Number(Giftcards[e][i].value));
return t}function calculateAdvancedPayment(e){e||(e=lastOrderId),Basket[e].paidByGiftCard=0,Basket[e].issueGiftCard=0;var t=Number(Basket[e].baseOrderTotal);1==Basket[e].lateDelivery?(t=Number(Basket[e].baseOrderTotalRebate),$("#lateDeliveryCheckbox"+lastOrderId).addClass("selected")):$("#lateDeliveryCheckbox"+lastOrderId).removeClass("selected");var i=0,a=0;$("#advancedPayment"+e+" input.subtractable").each(function(){var n=Number($(this).val());if(n){if(0>n)return n=0,void $(this).val(n);var d=$(this).attr("name");if("false"==Basket[e][d+"gratuityAllowed"]){if(n+a>t){var s=t-a;0>s&&(s=0);var o=s;alert("Tips ikke tillat for '"+GlobalPaymentMethods[d].description+"'. Reduserer til "+s),n=o,$(this).val(n),$(this).trigger("focusout")}a+=n}else i+=n}});var n=calculateGiftCardTotalValue(e);n+a+i>=t?Basket[e].paidByGiftCard=1:$("#advancedPayment"+e+" input.payable").each(function(){var n=Number($(this).val());if(n){if(0>n)return n=0,void $(this).val(n);var d=$(this).prop("name");if("false"==Basket[e][d+"gratuityAllowed"]){if(n+a>t){var s=t-a;0>s&&(s=0);var o=s;alert("Tips ikke tillat for betalingsmetode '"+GlobalPaymentMethods[d].description+"'. Reduserer til "+s),n=o,$(this).val(n),$(this).trigger("focusout")}a+=n}else i+=n}});var d=a+i+n;if(Basket[e].paidByGiftCard)d>t?($("#advancedPaymentRemaining"+e).html("<span style='color: green;'>Restbel&oslash;p (nytt gavekort)</span><em style='color: green;'>"+(d-t)+"</em>"),$("#completeAdvancedPayment"+e).hide(),$("#newGiftCard"+e).show(),$("#advancedPayment"+e+" ul li input.payable").each(function(){$(this).attr("disabled","disabled"),$(this).attr("value","0")})):($("#advancedPaymentRemaining"+e).html("Gjenst&aring;ende &aring; betale <em style='color: green;'>0</em>"),$("#newGiftCard"+e).hide(),$("#completeAdvancedPayment"+e).show()),$("#advancedPaymentTip"+e).hide();else{$("#advancedPaymentTip"+e).show(),$("#completeAdvancedPayment"+e).show(),$("#newGiftCard"+e).hide(),$("#advancedPayment"+e+" ul li input.payable").each(function(){$(this).removeAttr("disabled")});var s=t-d,o=0,l=0,r="color: black";s>0?(l=s,r="color: red"):0>s&&(o=-s),$("#advancedPaymentRemaining"+e).html("Gjenst&aring;ende &aring; betale <em style='"+r+"'>"+l+"</em>"),$("#advancedPaymentTip"+e).html("Tips <em style='color: black;'>"+o+"</em>")}}function emailList(e,t){var i=$(e).children(":selected").text();"Ingen kvittering"==i&&(i=""),$("#emailReceipt"+t).val(i),Basket[t].emailAddress=i}function emailChanged(e,t){Basket[e].emailAddress=t}function deliveryLateClick(e){ignoreClick||($("#deliveryLateItem"+e).hasClass("selected")?($("#deliveryLateItem"+e).removeClass("selected"),$("#deliveryLateItem"+e).parent().removeClass("selected"),$("#discountPayment"+e).css("text-decoration","line-through"),$("#discountPayment"+e).css("color","#999"),$("#discountPayment"+e+" strong").css("text-decoration","line-through"),$("#discountPayment"+e+" strong").css("color","#999"),$("#discountDetails"+e).hide(),Giftcards[e]||$("#subTotalDetails"+e).hide(),Basket[e].lateDelivery=0,calculateOrder(e)):($("#deliveryLateItem"+e).addClass("selected"),$("#deliveryLateItem"+e).parent().addClass("selected"),$("#discountDetails"+e).show(),$("#discountPayment"+e).show(),$("#discountPayment"+e).css("text-decoration","none"),$("#discountPayment"+e).css("color","green"),$("#discountPayment"+e+" strong").css("text-decoration","none"),$("#discountPayment"+e+" strong").css("color","green"),$("#subTotalDetails"+e).show(),$("#subTotalPayment"+e).show(),Basket[e].lateDelivery=1,calculateOrder(e)))}function addGiftCardClick(e){screenLevel=6,$("#payment").hide(),$("#addGiftCard").show(),$("#addGiftCard"+e).show()}function completeAddGiftCard(e){var t=$("#addGiftCardNumber"+e).val(),i=peppesEGCUrl+"?giftcardId="+t+"&orderNo="+e;desktopMode&&"12345"==localStorage.userID&&(i=localGiftCardUrl),$.ajax({type:"GET",url:i,dataType:"xml",success:function(t){processGiftCardReply(e,t),Log(activities.AddGiftCard)},error:function(){alert("Kunne ikke reservere gavekort "+t)}})}function processGiftCardReply(e,t){var i=t.xml?t.xml:(new XMLSerializer).serializeToString(t),a=$(t).find("giftcard");if(!a)return void alert(i);var n=$(a).attr("amount");n%1==0&&(n=Number(n));var d=$(a).attr("id");if(!d||!n)return void alert(i);Giftcards[e]||(Giftcards[e]=[]),$("#egcDetailsList"+e+" ul").append("<li id='detailsGiftCardItem"+d+"' class='giftCard enabled' >Gavekort - "+d+"<strong> -"+n+" kr</strong></li>");var s="<li id='paymentGiftCardItem"+d+"' class='giftCard enabled' title='"+d+";"+e+"'><div class='tap'>Gavekort - "+d+"<strong> -"+n+" kr</strong></div></li>";desktopMode&&(s="<li id='paymentGiftCardItem"+d+"' class='giftCard enabled' title='"+d+";"+e+"' onclick='giftCardClick("+d+","+e+")'><div class='tap'>Gavekort - "+d+"<strong> -"+n+" kr</strong></div></li>"),$("#egcPaymentList"+e+" ul").append(s),addTouchListener("paymentGiftCardItem"+d,onGiftCardTouchEnd),$("#egcStart"+e).after("<li><div class='egc enabled' id='advancedPaymentGiftCardItem"+d+"'>EGK-"+d+" <input class='egc' type='number' disabled='disabled' value='"+n+"'/></div></li>");var o=Giftcards[e].length;Giftcards[e][o]=[],Giftcards[e][o].id=d,Giftcards[e][o].value=n,Giftcards[e][o].status=1,calculateOrder(e),$("#addGiftCardNumber"+e).val(""),alert("Nytt gavekort "+d+" med saldo "+n+" er lagt til"),$("#addGiftCard"+e).hide(),$("#addGiftCard").hide(),$("#payment").show()}function cancelAddGiftCard(e){$("#addGiftCard"+e).hide(),$("#addGiftCard").hide(),$("#payment").show()}function giftCardClick(e,t){$("#paymentGiftCardItem"+e).hasClass("enabled")?($("#paymentGiftCardItem"+e).removeClass("enabled"),$("#detailsGiftCardItem"+e).removeClass("enabled"),$("#advancedPaymentGiftCardItem"+e).removeClass("enabled"),setGiftCardStatus(e,t,0)):($("#paymentGiftCardItem"+e).addClass("enabled"),$("#detailsGiftCardItem"+e).addClass("enabled"),$("#advancedPaymentGiftCardItem"+e).addClass("enabled"),setGiftCardStatus(e,t,1)),calculateOrder(t)}function setGiftCardStatus(e,t,i){for(var a=0;a<Giftcards[t].length;a++)if(Giftcards[t][a].id==e){Giftcards[t][a].status=i;break}}function calculateOrder(e){Basket[e].paidByGiftCard=0,Basket[e].issueGiftCard=0;var t=Basket[e].baseOrderTotal;if(1==Basket[e].lateDelivery&&(t=Basket[e].baseOrderTotalRebate),Giftcards[e])for(var i=0;i<Giftcards[e].length;i++)1==Giftcards[e][i].status&&(t-Giftcards[e][i].value<=0&&(Basket[e].paidByGiftCard=1),t-=Number(Giftcards[e][i].value));var a="&Aring; betale <strong> "+t+" kr</strong>";Basket[e].paidByGiftCard?(0>t&&(a="<span style='color: green'>Restbel&oslash;p (nytt gavekort) <strong> "+-(Math.round(100*t)/100)+" kr</strong><span>",Basket[e].issueGiftCard=1),$("#cardButton"+e).hide(),$("#giftCardButton"+e).hide(),$("#cashButton"+e).hide(),$("#completeButton"+e).show()):($("#completeButton"+e).hide(),$("#giftCardButton"+e).show(),$("#cashButton"+e).show(),$("#cardButton"+e).show(),screenLevel>3&&$("#calculator").show()),$("#grandTotalsPayment"+e).html(a),$("#grandTotalsDetails"+e).html(a)}function addTabTouchEventListeners(e){addTouchListener(e,onTab1TouchEnd)}function tapDetected(e){return isTouching=!1,e.currentTarget.moved===!0?(delete e.currentTarget.moved,!1):!0}function addTouchListener(e,t){if(!e)return void alert("AddTouchListener: elementId is null!");var i=document.getElementById(e);if(!i)return void alert("AddTouchListener: "+e+" is null!");i.addEventListener("touchstart",onTouchStart),i.addEventListener("touchmove",onTouchMove);var a=t;i.addEventListener("touchend",function(e){tapDetected(e)&&!ignoreClick&&a(e)})}function beginPayment(e){screenLevel=4,hideDestinationsDetails(),$(".paymentDetailsList").hide(),$("#paymentHeader").show(),$("#payment").show(),$("#payment #totals #paymentDetails"+e).show(),$("#payment #paymentButtons #paymentSelection"+e).show(),$("#calculator").show()}function verifyCellPhoneNumber(e){screenLevel=7,$("#payment").hide(),$("#payment #totals #paymentDetails"+e).hide(),$("#payment #paymentButtons #paymentSelection"+e).hide(),$("#verifyCellPhone").show(),$("#verifyCellPhone"+e).show()}function verifyCellPhoneNumberAdvancedPayment(e){var t=!1;$("#advancedPayment"+e+" input.subtractable").each(function(){var i=Number($(this).val());if(!(0>=i)){var a=$(this).prop("name");if("true"==GlobalPaymentMethods[a].discountCodeRequired){var n=$("#"+a+"-"+e+"-discount span"),d=n.attr("name");if(!d)return alert("Rabattkode mangler for "+GlobalPaymentMethods[a].description),void(t=!0)}if("true"==GlobalPaymentMethods[a].complaintCodeRequired){var s=$("#"+a+"-"+e+"-complaint span"),o=s.attr("name");if(!o)return alert("Reklamasjonskode mangler for "+GlobalPaymentMethods[a].description),void(t=!0);if(!Basket[e].complaintOrderLineList)return alert("Reklamasjon ufullstendig - mangler ordrelinjer"),void(t=!0)}}}),t||(screenLevel=13,$("#advancedPayment"+e).hide(),$("#reset").hide(),$("#calculator").hide(),showVerifyCellPhone())}function completeCellPhone(e){var t=$("#cellPhoneNumber"+e).val();t&&t.length>7&&t.length<12?(hideVerifyCellPhone(),Basket[e].cellPhoneNumber=t,13==screenLevel?completeAdvancedPayment(e):completePayment(e,-1),Log(activities.NewGiftCardIssued)):alert("Telefonnummeret "+t+" er ikke gyldig.")}function cancelCellPhone(e){onBackKeyDown()}function completePayment(e,t){var i="",a=Basket[e].baseOrderTotal;1==Basket[e].lateDelivery&&(a=Basket[e].baseOrderTotalRebate,i+="&lateDelivery=true");var n=Basket[e].emailAddress;if(n&&n.trim()&&(i+="&receiptEmail="+n.trim()),Giftcards[e]){for(var d=!1,s="",o=0;o<Giftcards[e].length;o++)1==Giftcards[e][o].status&&(a-=Giftcards[e][o].value,i+="&giftcardId="+Giftcards[e][o].id,d=!0);d&&(i+="&cellPhoneNumber="+Basket[e].cellPhoneNumber)}if(Basket[e].paidByGiftCard)Log(activities.OrderPaidByGiftCard),Basket[e].totalPaid=0;else{if(Basket[e].totalPaid=a,0==t){var l=a%1;l>=.5?a+=1-l:a-=l,i+="&paymentMethod="+paymentMethodCash,i+="&paymentAmount="+a}1==t&&(i+="&paymentMethod="+paymentMethodCard,i+="&paymentAmount="+a)}completeDelivery(e,i)}function completeAdvancedPayment(e){if(!ignoreClick){e||(e=lastOrderId);var t="",i=Number(Basket[e].baseOrderTotal);1==Basket[e].lateDelivery&&(i=Number(Basket[e].baseOrderTotalRebate),t+="&lateDelivery=true");var a=Basket[e].emailAddress;a&&a.trim()&&(t+="&receiptEmail="+a.trim());var n=0;if(Giftcards[e]){for(var d=!1,s="",o=0;o<Giftcards[e].length;o++)1==Giftcards[e][o].status&&(i-=Giftcards[e][o].value,t+="&giftcardId="+Giftcards[e][o].id,d=!0);d&&(t+="&cellPhoneNumber="+Basket[e].cellPhoneNumber)}var l=!1;if($("#advancedPayment"+e+" input.subtractable").each(function(){var i=Number($(this).val());if(!(0>=i)){n+=i;var a=$(this).prop("name");if(t+="&paymentMethod="+a+"&paymentAmount="+i,"true"==GlobalPaymentMethods[a].discountCodeRequired){var d=$("#"+a+"-"+e+"-discount span"),s=d.attr("name");if(!s)return alert("Rabattkode mangler for "+GlobalPaymentMethods[a].description),void(l=!0);t+="&discountCode="+s}if("true"==GlobalPaymentMethods[a].complaintCodeRequired){var o=$("#"+a+"-"+e+"-complaint span"),r=o.attr("name");if(!r)return alert("Reklamasjonskode mangler for "+GlobalPaymentMethods[a].description),void(l=!0);if(!Basket[e].complaintOrderLineList)return alert("Reklamasjon ufullstendig - mangler ordrelinjer"),void(l=!0);t+="&complaintCode="+r+"&"+Basket[e].complaintOrderLineList}}}),Basket[e].paidByGiftCard?i=n:$("#advancedPayment"+e+" input.payable").each(function(){if(!l){var e=Number($(this).val());if(!(0>=e)){n+=e;var i=$(this).prop("name");t+="&paymentMethod="+i+"&paymentAmount="+e}}}),!l){var r=i-n;if(r>0)return void alert("Manko "+r+" kr. Kan ikke levere ordre.");Basket[e].totalPaid=n,Basket[e].gratuity=Number(-r),completeDelivery(e,t)}}}function completeDelivery(e,t,i){var a=peppesDeliveryOrderUrl+"?employeeId="+localStorage.userID+"&delivered=true";if(null!=t&&t.length>0&&(a+=t),a+="&orderNo="+e,Basket[e].sign){var n=a.slice(a.indexOf("?")+1,a.length);n+="&sign="+Basket[e].sign,$.ajax({type:"POST",url:peppesDeliveryOrderUrl,dataType:"xml",data:n,success:function(e){var t=e.xml?e.xml:(new XMLSerializer).serializeToString(e);"<result/>"!=t&&(alert(t),Log(activities.error,t))},error:function(e){alert("Kunne ikke levere pizza.")}})}else $.ajax({type:"GET",url:a,dataType:"xml",success:function(e){var t=e.xml?e.xml:(new XMLSerializer).serializeToString(e);"<result/>"!=t&&(alert(t),Log(activities.error,t))},error:function(e){alert("Kunne ikke levere pizza.")}});var d=$("#listItem"+e).html();$("#listItem"+e).remove(),$("#destinationList .delivered").append("<div class='destinationListItem listitem' onClick='viewCustomer("+e+")' id='listItem"+e+"'></div>"),$("#destinationList .delivered #listItem"+e).append(d),Basket[e].lateDelivery?($("#destinationList .delivered #listItem"+e+" em").html("Forsinket!"),Log(activities.OrderDeliveredLate,a)):($("#destinationList .delivered #listItem"+e+" em").html("OK!"),Log(activities.OrderDelivered,a)),$("#destinationList .delivered #listItem"+e+" em").removeClass("timestamp"),$("#detailsList"+e+" .button").hide(),$("#detailsItem"+e+" .button").hide(),$("#payButton"+e+" .button").hide(),$("#grandTotalsDetails"+e).html("Betalt <strong>"+Number(Basket[e].totalPaid)+"</strong>"),Basket[e].gratuity>0&&$("#grandTotalsDetailsList"+e+" ul").append("<li style='color: green'>Herav tips <strong> "+Number(Basket[e].gratuity)+"</strong></li>"),(8==screenLevel||13==screenLevel)&&hideAdvancedPayment(),backToList()}function viewCustomer(e){lastOrderId=e,$("#destinationsListHeader").hide(),$("#destinationsList").hide(),$(".destinationsDetailsItem").hide(),$(".destinationsDetailsList").hide(),$("#destinationsDetailsHeader").show(),$("#destinations").show(),$("#detailsItem"+e).show(),$("#detailsList"+e).show(),screenLevel=3}function backToList(){$("#tab2").removeClass("selected"),$("#destinationsDetailsHeader").hide(),$("#destinations").hide(),$("#destinationItemList").hide(),$(".destinationsDetailsItem").hide(),$(".destinationsDetailsList").hide(),$("#tab1").addClass("selected"),$("#destinationsListHeader").show(),$("#destinationsList").show(),$("#destinationInfo").show(),$(".delivered").show(),hidePayment(),screenLevel=2}function arriveAtCustomer(){Log(activities.arriveAtCustomer),showDestinationItemList()}function onCalculatorClick(){hidePayment(),$("#calculator").show(),$("#reset").show(),calculateAdvancedPayment(lastOrderId),$("#advancedPaymentHeader").show(),$("#advancedPayment").show(),$("#advancedPayment"+lastOrderId).show(),screenLevel=8}function onLateDeliveryCheckboxClicked(e){0==Basket[lastOrderId].lateDelivery?(Basket[lastOrderId].lateDelivery=1,$("#lateDeliveryCheckbox"+lastOrderId).addClass("selected")):(Basket[lastOrderId].lateDelivery=0,$("#lateDeliveryCheckbox"+lastOrderId).removeClass("selected")),deliveryLateClick(lastOrderId),calculateAdvancedPayment(lastOrderId)}function onPadLockClick(){screenLocked?(screenLocked=!1,$("#padlock img").attr("src","img/padlock-open.png")):(screenLocked=!0,$("#padlock img").attr("src","img/padlock-closed.png"))}function initTimer(){timer(),window.setInterval(timer,1e3)}function timer(){$(".timestamp").each(function(e){$(this).html(deliverWithin($(this).attr("title")))})}function GetUnixTime(){return parseInt((new Date).getTime())}function timeAgo(e){return since=(e-GetUnixTime())/6e4,since=Math.ceil(-since),since>=50?"<span style='color: red;'>"+since+" min </span>":since+" min"}function deliverWithin(e){var t=Math.ceil((e-GetUnixTime())/6e4);return 0>t?"<span style='color: red;'>"+t+" min</span>":t+" min"}function timeFromUnix(e){var t=new Date(e),i=t.getHours(),a=t.getMinutes();return 9>=a&&(a="0"+a),i+":"+a}function disableAllLinks(){$("a[href*=#]").each(function(){event.preventDefault()})}function checkForConnectionTimer(){window.setInterval(checkForConnection,1e4)}function localstorageLoad(){resetApp(!0),$("#loginDiv").hide(),$("#welcome").hide(),$("#loader").show(),xml=localStorage.xml,parseXML(xml)}function resetApp(e){hideAll(),$("#wrapper").html('<div id="loginDiv" style=""><input id="pincode" type="number" name="pincode" /><div class="button" onclick="doLogin();"><div> Login </div> </div> </div><div id="products" style="display:none;"><div class="list" id="productList"></div><div class="footer"><div class="button disabled" id="productsDone"><div> Varer igjen <span id="products-total">1</span> </div> </div> </div> </div><div id="destinationsList" style="display:none;"><div id="destinationList"><div class="normal"><div class="listheader"> Bestillinger </div> </div><div style="display:none;" class="preorder"><div class="listheader"> Forh&aring;ndsbestillinger </div> </div><div style="display:none;" class="delivered"><div class="listheader"> Levert </div> </div> </div> </div><div id="destinations" style="display:none;"><div class="tabs"><div class="tab selected" id="tab1" onclick="showDestinationInfo();"> Kunde </div><div class="tab" id="tab2" onclick="showDestinationItemList();"> Varer </div> </div><div id="destinationsDetails"><div id="destinationInfo"></div><div id="destinationItemList" style="display: none;"></div></div></div><div id="payment"><div id="totals"></div><div id="paymentButtons"></div></div><div id="addGiftCard" style="display: none"></div><div id="verifyCellPhone"></div><div id="advancedPayment"></div><div id="discountSelection" style="display: none"></div><div style="display: none;" id="complaintSelection"></div><div id="complaintOrderLineSelection" style="display: none"></div>'),$("#loginDiv").show(),$("#welcome").show(),clearCanvas(),Basket=[],Giftcards=[],DiscountCodes=[],ComplaintCodes=[],PaymentMethods=[],GlobalPaymentMethods=[],lastOrderId=0,lastPaymentCode="",screenLevel=0,ignoreClick=!1,screenLocked=!1,$("#padlock img").attr("src","img/padlock-open.png"),isTouching=!1}function hideAll(){$("#sign").hide(),$("#padlock").hide(),$("#reset").hide(),$("#loader").hide(),$("#products").hide(),$("#calculator").hide(),$("#destinationsList").hide(),$("#destinationsListHeader").hide(),$("#destinationsDetailsHeader").hide(),$("#advancedPaymentHeader").hide(),$("#productHeader").hide(),$("#products").hide(),hidePayment(),hideDiscountSelection(),hideComplaintSelection(),hideComplaintOrderLineSelection()}function sign(e){screenLevel=9,$("#destinations").hide(),$("#sign").show(),$("#signButton"+e).show()}function clearCanvas(){canvas=document.getElementById("imageView"),context=canvas.getContext("2d"),context.fillStyle="rgb(255,255,255)",context.fillRect(0,0,320,340),context.fillStyle="rgb(200,200,200)",context.fillRect(40,4,3,332)}function signSave(e){$("#saveSignInfo").show(),saveImageData(e)}function saveImageData(e){var t=e,i=document.getElementById("imageView"),a=i.toDataURL().substr(22);a=a.replace(/\+/g,"-"),a=a.replace(/\//g,"_"),a.length>128?(Basket[t].sign=a,continueAfterSign(t)):alert("Signatur feilet: ingen signatur? "+a),continueAfterSign(t)}function continueAfterSign(e){screenLevel=5,clearCanvas(),$("#sign").hide(),$("#signButton"+e).hide(),$("#showSignButton"+e).hide(),$("#saveSignInfo").hide(),$("#destinationsDetailsHeader").hide(),$("#deliveryButton"+e).show(),$("#deliveryLateItem"+e).show(),$("#paymentHeader").show(),$("#payment").show(),$("#payment #totals #paymentDetails"+e).show(),$("#payment #paymentButtons #paymentSelection"+e).show(),$("#calculator").show()}function testConnection(){alert("Laster ruten fra server.."),resetApp();var e=0;e=desktopMode?triggerOfflineSwap():checkForConnectionAtLoad(),e&&($("#offline").hide(),$("#loginDiv").hide(),$("#welcome").hide(),$("#productHeader").show(),$("#loader").show(),userpin=localStorage.userID,loadXML(userpin))}function debug(){}var Basket=[],PaymentMethods=[],GlobalPaymentMethods=[],Giftcards=[],DiscountCodes=[],ComplaintCodes=[],lastOrderId=0,lastPaymentCode="",currentversion="3.3",paymentMethodCash="K",paymentMethodCard="MB",paymentMethodGiftCard="GA",paymentMethodInvoice="F",paymentMethodLateDelivery="SL",screenLevel=0,isTouching=!1,ignoreClick=!1,screenLocked=!1,localDriverOrdersUrl="http://localhost/FetchDriverTotalOrder2.xml",localGiftCardUrl="http://localhost:8080/giftcard.xml",phoneLocalDriverOrdersUrl="svarer_27-02-2013.xml",fxlLogUrl="http://fluxloop.com/peppes/log.php",peppesApiUrl="https://www.peppes.no/peppesapi",peppesVersionUrl="http://fluxloop.com/peppesversion.php?bust="+Math.floor(100*Math.random()),peppesDriverOrdersUrl=peppesApiUrl+"/FetchDriverTotalOrder",peppesEGCUrl=peppesApiUrl+"/AuthorizeGiftCard",peppesDeliveryOrderUrl=peppesApiUrl+"/DeliverDriverOrder",desktopModePossible=!0,desktopMode=!1,offlineMode=!1,debugmode=!1,activities=[];activities.OrderDelivered="OrderDelivered",activities.OrderDeliveredLate="OrderDeliveredLate",activities.OrderReturned="OrderDeliveredReturned",activities.AdvancedPaymentComplete="AdvancedPaymentComplete",activities.AllItemsPicked="AllItemsPicked",activities.LastOrderDelivered="LastOrderDelivered",activities.Login="Login",activities.AddGiftCard="AddGiftCard",activities.NewGiftCardIssued="NewGiftCardIssued",activities.OrderPaidByGiftCard="OrderPaidByGiftCard",activities.arriveAtCustomer="arriveAtCustomer",activities.error="error";var debugOnCounter=0,deliveryReturn=function(e){currentOID=e;var t=function(e){if(1==e){deliveryURL=peppesDeliveryOrderUrl+"?employeeId="+localStorage.userID+"&delivered=true&postponeSettlement=true&orderNo="+currentOID,$.ajax({type:"GET",url:deliveryURL,dataType:"xml",success:function(e){var t=e.xml?e.xml:(new XMLSerializer).serializeToString(e);"<result/>"!=t&&alert(t)},error:function(){alert("Kunne ikke levere pizza.")}}),Log(activities.OrderReturned);var t=$("#listItem"+currentOID).html();$("#listItem"+currentOID).remove(),$("#destinationList .delivered").append("<div class='destinationListItem listitem' onClick='viewCustomer("+currentOID+")' id='listItem"+currentOID+"'></div>"),$("#destinationList .delivered #listItem"+currentOID).append(t),$("#destinationList .delivered #listItem"+currentOID+" em").removeClass("timestamp"),$("#destinationList .delivered #listItem"+currentOID+" em").html("Retur!"),$("#detailsList"+currentOID+" .button").hide(),$("#detailsItem"+currentOID+" .button").hide(),backToList()}};return desktopMode?void t(1):void navigator.notification.confirm("Returnere ordren? ",t,"Levering","Ja,Nei")};1==debugmode&&$("#debug").show();